import { createElement } from "react";
import { renderToStaticMarkup } from "react-dom/server";
import { describe, expect, it } from "vitest";
import { LandingPage } from "@/components/landing-page";
import { buildPreviewInviteUrl, getPreviewDomain } from "@/lib/imessage-preview";

describe("landing page invite preview", () => {
  it("renders the refreshed landing flow while preserving iMessage thread behavior", () => {
    const markup = renderToStaticMarkup(createElement(LandingPage, { referralCode: "ABC123" }));
    const expectedDomain = getPreviewDomain(buildPreviewInviteUrl("ABC123"));
    const heroGamesIndex = markup.indexOf("hero-games");
    const heroIndex = markup.indexOf("Smart games and puzzles that you&#x27;ll look forward to each day.");
    const gamesIndex = markup.indexOf("Moji Mash");
    const previewIndex = markup.indexOf("imessage-thread");
    const waitlistIndex = markup.indexOf("Get early access.");
    const stepsIndex = markup.indexOf("01 Join");
    const incomingScoreIndex = markup.indexOf("#106 3/6");
    const outgoingPreviewIndex = markup.indexOf("link-bubble");
    const outgoingFollowupIndex = markup.indexOf("join the daybreak beta with my link and it will make a dedicated group for us");

    expect(markup).not.toContain("ios-device-frame");
    expect(markup).not.toContain('class="screen-header">iMessage invite preview');
    expect(markup).toContain("hero-games");
    expect(markup).toContain("Smart games and puzzles that you&#x27;ll look forward to each day.");
    expect(markup).toContain("Daily games, dynamic difficulty, and groups that stay in sync.");
    expect(markup).toContain("Start Playing");
    expect(markup).not.toContain("hero-actions");
    expect(markup).not.toContain("Today in Gameshow");
    expect(markup).not.toContain("A lineup you&#x27;ll open every day.");
    expect(markup).toContain("Bridges");
    expect(markup).toContain("Barter");
    expect(markup).toContain("Moji Mash");
    expect(markup).toContain("Wordie");
    expect(markup).toContain("Mini Sudoku");
    expect(markup).toContain("Whodunit");
    expect(markup).toContain("Trivia");
    expect(markup).toContain("Mini Crossword");
    expect(markup).toContain("Import your games group chat in one click");
    expect(markup).toContain("Daybreak groups share your daily game results with your friends.");
    expect(markup).toContain("#106 3/6");
    expect(markup).toContain("拘拘游릳拘拘");
    expect(markup).toContain("拘游릴拘拘拘");
    expect(markup).toContain("游릴游릴游릴游릴游릴");
    expect(markup).toContain("ngl I got lucky today");
    expect(markup).toContain("Today");
    expect(markup).toContain("typing-bubble");
    expect(markup).toContain("imessage-contact-avatar");
    expect(markup).toContain("Sam");
    expect(markup).toContain("join the daybreak beta with my link and it will make a dedicated group for us");
    expect(markup).not.toContain("4 guesses is elite.");
    expect(markup).not.toContain("Daybreak is a calm daily ritual");
    expect(markup).not.toContain("How It Works");
    expect(markup).toContain("/api/og/invite/ABC123.png");
    expect(markup).toContain(expectedDomain);
    expect(heroGamesIndex).toBeGreaterThan(-1);
    expect(heroIndex).toBeGreaterThan(-1);
    expect(gamesIndex).toBeGreaterThan(heroGamesIndex);
    expect(previewIndex).toBeGreaterThan(gamesIndex);
    expect(waitlistIndex).toBeGreaterThan(-1);
    expect(waitlistIndex).toBeGreaterThan(previewIndex);
    expect(stepsIndex).toBeGreaterThan(waitlistIndex);
    expect(incomingScoreIndex).toBeGreaterThan(-1);
    expect(outgoingPreviewIndex).toBeGreaterThan(incomingScoreIndex);
    expect(outgoingFollowupIndex).toBeGreaterThan(outgoingPreviewIndex);
  });
});
